<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON query</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/fontawesome.min.css"
        integrity="sha384-QYIZto+st3yW+o8+5OHfT6S482Zsvz2WfOzpFSXMF9zqeLcFV0/wlZpMtyFcZALm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.1.js"
        integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
</head>

<body>
    <div class="d-flex container">
        <div class="col-6 pe-3">
            <h2>JSON</h2>
            <textarea id="originJSON" class="form-control" style="height: calc(100vh - 50px)">
                { "key": "value", "arrs": ["a", "b"]}
            </textarea>
        </div>
        <div id="json-queries" class="col-6 d-flex flex-column gap-2">
            <h2>Query</h2>
            <div class="d-flex gap-2">
                <span>Add more queries:</span>
                <div class="input-group" style="width: 120px">
                    <input name="addingAmount" type="number" class="form-control" value="1"
                        aria-label="Recipient's username with two button addons">
                    <button name="subtractOneAmount" class="btn btn-outline-secondary" type="button"> -
                    </button>
                    <button name="addOneAmount" class="btn btn-outline-secondary" type="button"> +
                    </button>
                </div>
                <button name="addQueryButton" class="btn btn-info">Add</button>
            </div>
            <div class="json-query">
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">JQL</span>
                    <input type="text" json-query value="key" class="form-control"></input>
                </div>
                <p json-query-result></p>
            </div>
            <div class="json-query">
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">JQL</span>
                    <input type="text" json-query value="arrs.0" class="form-control"></input>
                </div>
                <p json-query-result></p>
            </div>
            <div class="json-query">
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">JQL</span>
                    <input type="text" json-query value="arrs.0" class="form-control"></input>
                </div>
                <p json-query-result></p>
            </div>
            <div class="json-query">
                <div class="input-group">
                    <span class="input-group-text" id="basic-addon1">JQL</span>
                    <input type="text" json-query value="arrs.0" class="form-control"></input>
                </div>
                <p json-query-result></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { findNodeByQuery } from "/src/js/json-query.js";

        var jsonInputElement = $('#originJSON')
        var object = JSON.parse(jsonInputElement.val())

        function updateResultForQuery(jsonQueryExprElement) {
            let self = $(jsonQueryExprElement)
            const queryExpr = self.val()
            const foundNode = findNodeByQuery(object, queryExpr)
            self.parent().siblings('p[json-query-result]').text(JSON.stringify(foundNode) || 'undefined')
        }

        function changeAddingAmount(action) {
            const addingElement = $('input[name=addingAmount]')
            const currentAddingAmount = addingElement.val()
            if (action == 'ADD') {
                addingElement.val(currentAddingAmount - -1)
            } else if (action == 'SUBTRACT' && currentAddingAmount > 1) {
                addingElement.val(currentAddingAmount - 1)
            }
        }

        function addQuery() {
            const addingAmount = $('input[name=addingAmount]').val()
            const queryTemplate =
                `<div class="json-query">
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">JQL</span>
                        <input type="text" json-query class="form-control"></input>
                    </div>
                    <p json-query-result></p>
                </div>`
            const newQueryElement = $(queryTemplate);
            newQueryElement.focusout(event => { updateResultForQuery(event.target) });
            $("#json-queries").append(newQueryElement)
        }

        $(document).ready(function () {

            jsonInputElement.focusout(() => {
                object = JSON.parse(jsonInputElement.val())
                const jsonQueryExprElements = $("input[json-query]")
                jsonQueryExprElements.each((index, jsonQueryExprElement) => updateResultForQuery(jsonQueryExprElement))
            })
            jsonInputElement.focusout();

            var jsonQueryExprElements = $("input[json-query]")
            jsonQueryExprElements.focusout(event => { updateResultForQuery(event.target) });

            $("button[name=addOneAmount]").click(() => changeAddingAmount('ADD'))
            $("button[name=subtractOneAmount]").click(() => changeAddingAmount('SUBTRACT'))
            $("button[name=addQueryButton]").click(addQuery)
        })
    </script>

    <style>
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</body>

</html>